---
sidebar_position: 12
---

# Implementación de un Sistema de Copias de Seguridad en el Cloud con Bacula

## Requisitos

Para esta práctica, necesitarás:

* Dos instancias basadas en Ubuntu Server 24.04 en el cloud.
* Un volumen adicional de almacenamiento para la instancia que actuará como servidor de copias de seguridad.
* Conocimientos básicos de administración de sistemas y uso de la terminal.

## Introducción

En este artículo, configuraremos un sistema de copias de seguridad utilizando Bacula, con una de las instancias en el cloud como servidor de copias de seguridad. El proceso será completamente automático, almacenando las copias en un volumen adicional y utilizando claves públicas y privadas para la autenticación. Implementaremos copias completas semanales y diferenciales diarias, y un plan de almacenamiento a largo plazo. Además, se cifrarán los datos críticos y se almacenarán en una ubicación secundaria.

## Paso 1: Preparación del Entorno

### En la Instancia del Servidor

1. **Anexar el Volumen de Almacenamiento**:

   Asumiendo que el volumen adicional está anexado como `/dev/sdb`.

2. **Crear una Tabla de Particiones y Formatear el Volumen**:

   Utiliza `fdisk` para crear una nueva partición en el volumen:

   ```bash
   sudo fdisk /dev/sdb
   ```

   En el shell de `fdisk`, realiza los siguientes pasos:
   - Presiona `n` para crear una nueva partición.
   - Presiona `p` para elegir una partición primaria.
   - Presiona `1` para elegir el número de partición.
   - Presiona `Enter` para aceptar el valor predeterminado del primer sector.
   - Presiona `Enter` nuevamente para aceptar el valor predeterminado del último sector.
   - Presiona `w` para escribir la tabla de particiones y salir.

   Luego, formatea la partición recién creada:

   ```bash
   sudo mkfs.ext4 /dev/sdb1
   ```

3. **Montar el Volumen**:

   Crea un punto de montaje y monta el volumen:

   ```bash
   sudo mkdir -p /mnt/backups
   sudo mount /dev/sdb1 /mnt/backups
   sudo chown -R $USER:$USER /mnt/backups
   ```

### En la Instancia del Cliente

1. **Instalar Bacula en el Servidor**:

   ```bash
   sudo apt update
   sudo apt install bacula-server -y
   ```

2. **Instalar Bacula en el Cliente**:

   ```bash
   sudo apt update
   sudo apt install bacula-client -y
   ```

## Paso 2: Configuración de Bacula

### En el Servidor

1. **Configurar el Directorio de Almacenamiento**:

   Edita el archivo `/etc/bacula/bacula-sd.conf` y configura el dispositivo de almacenamiento:

   ```bash
   sudo nano /etc/bacula/bacula-sd.conf
   ```

   Cambia las rutas de los dispositivos de archivo para que apunten a los directorios adecuados en `/mnt/backups` y actualiza `SDAddress` para que apunte a la IP del servidor.

   **`bacula-sd.conf` Completo**:

   ```conf
   #
   # Default Bacula Storage Daemon Configuration file
   #
   # You may need to change the name of your tape drive
   #   on the "Archive Device" directive in the Device
   #   resource.  If you change the Name and/or the
   #   "Media Type" in the Device resource, please ensure
   #   that dird.conf has corresponding changes.
   #
   #
   # Copyright (C) 2000-2022 Kern Sibbald
   # License: BSD 2-Clause; see file LICENSE-FOSS
   #

   Storage {                             # definition of myself
     Name = bacula-servidor-sd
     SDPort = 9103                  # Director's port
     WorkingDirectory = "/var/lib/bacula"
     Pid Directory = "/run/bacula"
     Plugin Directory = "/usr/lib/bacula"
     Maximum Concurrent Jobs = 20
     SDAddress = 192.168.0.10
   }

   #
   # List Directors who are permitted to contact Storage daemon
   #
   Director {
     Name = bacula-servidor-dir
     Password = "50KrHDxD4WLDMmfDlQf6Ba0eNA4TwGrpX"
   }

   #
   # Restricted Director, used by tray-monitor to get the
   #   status of the storage daemon
   #
   Director {
     Name = bacula-servidor-mon
     Password = "-4e9pjc8atAgwtCpYxiSBPozQVoL-xMVB"
     Monitor = yes
   }

   #
   # Devices supported by this Storage daemon
   # To connect, the Director's bacula-dir.conf must have the
   #  same Name and MediaType.
   #

   #
   # Define a Virtual autochanger
   #
   Autochanger {
     Name = FileChgr1
     Device = FileChgr1-Dev1, FileChgr1-Dev2
     Changer Command = ""
     Changer Device = /dev/null
   }

   Device {
     Name = FileChgr1-Dev1
     Media Type = File1
     Archive Device = /mnt/backups/file1
     LabelMedia = yes;                   # lets Bacula label unlabeled media
     Random Access = Yes;
     AutomaticMount = yes;               # when device opened, read it
     RemovableMedia = no;
     AlwaysOpen = no;
     Maximum Concurrent Jobs = 5
   }

   Device {
     Name = FileChgr1-Dev2
     Media Type = File1
     Archive Device = /mnt/backups/file1
     LabelMedia = yes;                   # lets Bacula label unlabeled media
     Random Access = Yes;
     AutomaticMount = yes;               # when device opened, read it
     RemovableMedia = no;
     AlwaysOpen = no;
     Maximum Concurrent Jobs = 5
   }

   #
   # Define a second Virtual autochanger
   #
   Autochanger {
     Name = FileChgr2
     Device = FileChgr2-Dev1, FileChgr2-Dev2
     Changer Command = ""
     Changer Device = /dev/null
   }

   Device {
     Name = FileChgr2-Dev1
     Media Type = File2
     Archive Device = /mnt/backups/file2
     LabelMedia = yes;                   # lets Bacula label unlabeled media
     Random Access = Yes;
     AutomaticMount = yes;               # when device opened, read it
     RemovableMedia = no;
     AlwaysOpen = no;
     Maximum Concurrent Jobs = 5
   }

   Device {
     Name = FileChgr2-Dev2
     Media Type = File2
     Archive Device = /mnt/backups/file2
     LabelMedia = yes;                   # lets Bacula label unlabeled media
     Random Access = Yes;
     AutomaticMount = yes;               # when device opened, read it
     RemovableMedia = no;
     AlwaysOpen = no;
     Maximum Concurrent Jobs = 5
   }

   Messages {
     Name = Standard
     director = bacula-servidor-dir@192.168.0.10 = all
   }
   ```

2. **Configurar el Director**:

   Edita el archivo `/etc/bacula/bacula-dir.conf` y configura los recursos de cliente y trabajos:

   ```bash
   sudo nano /etc/bacula/bacula-dir.conf
   ```

   **`bacula-dir.conf` **:

   ```conf
   #
   # Default Bacula Director Configuration file
   #
   #  The only thing that MUST be changed is to add one or more
   #   file or directory names in the Include directive of the
   #   FileSet resource.
   #
   #  You might also want to change the default email address
   #   from root to your address.  See the "mail" and "operator"
   #   directives in the Messages resource.
   #
   # Copyright (C) 2000-2022 Kern Sibbald
   # License: BSD 2-Clause; see file LICENSE-FOSS
   #

   Director {                            # define myself
     Name = bacula-servidor-dir
     DIRport = 9101                # where we listen for UA connections
     QueryFile = "/etc/bacula/scripts/query.sql"
     WorkingDirectory = "/var/lib/bacula"
     PidDirectory = "/run/bacula"
     Maximum Concurrent Jobs = 20
     Password = "qutMbui6jgiqLHGIEp8ai1K0qCN4bnRpX"         # Console password
     Messages = Daemon
     DirAddress = 192.168.0.10
   }

   JobDefs {
     Name = "DefaultJob"
     Type = Backup
     Level = Incremental
     Client = bacula-servidor-fd
     FileSet = "Full Set"
     Schedule = "WeeklyCycle"
     Storage = File1
     Messages = Standard
     Pool = File
     SpoolAttributes = yes
     Priority

 = 10
     Write Bootstrap = "/var/lib/bacula/%c.bsr"
   }

   #
   # Define the main nightly save backup job
   #   By default, this job will back up to disk in /nonexistent/path/to/file/archive/dir
   Job {
     Name = "BackupClient1"
     JobDefs = "DefaultJob"
     Client = bacula-cliente-fd
   }

   # Backup the catalog database (after the nightly save)
   Job {
     Name = "BackupCatalog"
     JobDefs = "DefaultJob"
     Level = Full
     FileSet="Catalog"
     Schedule = "WeeklyCycleAfterBackup"
     # This creates an ASCII copy of the catalog
     # Arguments to make_catalog_backup.pl are:
     #  make_catalog_backup.pl <catalog-name>
     RunBeforeJob = "/etc/bacula/scripts/make_catalog_backup.pl MyCatalog"
     # This deletes the copy of the catalog
     RunAfterJob  = "/etc/bacula/scripts/delete_catalog_backup"
     Write Bootstrap = "/var/lib/bacula/%n.bsr"
     Priority = 11                   # run after main backup
   }

   #
   # Standard Restore template, to be changed by Console program
   #  Only one such job is needed for all Jobs/Clients/Storage ...
   #
   Job {
     Name = "RestoreFiles"
     Type = Restore
     Client=bacula-servidor-fd
     Storage = File1
   # The FileSet and Pool directives are not used by Restore Jobs
   # but must not be removed
     FileSet="Full Set"
     Pool = File
     Messages = Standard
     Where = /nonexistent/path/to/file/archive/dir/bacula-restores
   }

   # List of files to be backed up
   FileSet {
     Name = "Full Set"
     Include {
       Options {
         signature = MD5
       }
       File = /home
       File = /etc
       File = /root
       File = /var/log
     }

     Exclude {
       File = /var/lib/bacula
       File = /nonexistent/path/to/file/archive/dir
       File = /proc
       File = /tmp
       File = /sys
       File = /.journal
       File = /.fsck
     }
   }

   #
   # When to do the backups, full backup on first sunday of the month,
   #  differential (i.e. incremental since full) every other sunday,
   #  and incremental backups other days
   Schedule {
     Name = "WeeklyCycle"
     Run = Full 1st sun at 23:05
     Run = Differential 2nd-5th sun at 23:05
     Run = Incremental mon-sat at 23:05
   }

   # This schedule does the catalog. It starts after the WeeklyCycle
   Schedule {
     Name = "WeeklyCycleAfterBackup"
     Run = Full sun-sat at 23:10
   }

   # This is the backup of the catalog
   FileSet {
     Name = "Catalog"
     Include {
       Options {
         signature = MD5
       }
       File = "/var/lib/bacula/bacula.sql"
     }
   }

   # Client (File Services) to backup
   Client {
     Name = bacula-servidor-fd
     Address = 192.168.0.10
     FDPort = 9102
     Catalog = MyCatalog
     Password = "WVS6AjYuHBBuk-zODbDsOPt4-kzHGkvh6"          # password for FileDaemon
     File Retention = 60 days            # 60 days
     Job Retention = 6 months            # six months
     AutoPrune = yes                     # Prune expired Jobs/Files
   }

   # Second Client (File Services) to backup
   Client {
     Name = bacula-cliente-fd
     Address = 192.168.0.11
     FDPort = 9102
     Catalog = MyCatalog
     Password = "somepassword"        # password for FileDaemon
     File Retention = 60 days           # 60 days
     Job Retention = 6 months           # six months
     AutoPrune = yes                    # Prune expired Jobs/Files
   }

   # Definition of file Virtual Autochanger device
   Autochanger {
     Name = File1
     Address = 192.168.0.10                # N.B. Use a fully qualified name here
     SDPort = 9103
     Password = "50KrHDxD4WLDMmfDlQf6Ba0eNA4TwGrpX"
     Device = FileChgr1
     Media Type = File1
     Maximum Concurrent Jobs = 10        # run up to 10 jobs at the same time
     Autochanger = File1                 # point to ourself
   }

   # Definition of a second file Virtual Autochanger device
   Autochanger {
     Name = File2
     Address = 192.168.0.10                # N.B. Use a fully qualified name here
     SDPort = 9103
     Password = "50KrHDxD4WLDMmfDlQf6Ba0eNA4TwGrpX"
     Device = FileChgr2
     Media Type = File2
     Autochanger = File2                 # point to ourself
     Maximum Concurrent Jobs = 10        # run up to 10 jobs at the same time
   }

   # Generic catalog service
   Catalog {
     Name = MyCatalog
     dbname = "bacula"; DB Address = "localhost"; dbuser = "bacula"; dbpassword = "a"
   }

   # Reasonable message delivery -- send most everything to email address
   #  and to the console
   Messages {
     Name = Standard
     mailcommand = "/usr/sbin/bsmtp -h localhost -f \"\(Bacula\) \<%r\>\" -s \"Bacula: %t %e of %c %l\" %r"
     operatorcommand = "/usr/sbin/bsmtp -h localhost -f \"\(Bacula\) \<%r\>\" -s \"Bacula: Intervention needed for %j\" %r"
     mail = root = all, !skipped
     operator = root = mount
     console = all, !skipped, !saved
     append = "/var/log/bacula/bacula.log" = all, !skipped
     catalog = all
   }

   #
   # Message delivery for daemon messages (no job).
   Messages {
     Name = Daemon
     mailcommand = "/usr/sbin/bsmtp -h localhost -f \"\(Bacula\) \<%r\>\" -s \"Bacula daemon message\" %r"
     mail = root = all, !skipped
     console = all, !skipped, !saved
     append = "/var/log/bacula/bacula.log" = all, !skipped
   }

   # Default pool definition
   Pool {
     Name = Default
     Pool Type = Backup
     Recycle = yes                       # Bacula can automatically recycle Volumes
     AutoPrune = yes                     # Prune expired volumes
     Volume Retention = 365 days         # one year
     Maximum Volume Bytes = 50G          # Limit Volume size to something reasonable
     Maximum Volumes = 100               # Limit number of Volumes in Pool
   }

   # File Pool definition
   Pool {
     Name = File
     Pool Type = Backup
     Recycle = yes                       # Bacula can automatically recycle Volumes
     AutoPrune = yes                     # Prune expired volumes
     Volume Retention = 365 days         # one year
     Maximum Volume Bytes = 50G          # Limit Volume size to something reasonable
     Maximum Volumes = 100               # Limit number of Volumes in Pool
     Label Format = "Vol-"               # Auto label
   }

   # Scratch pool definition
   Pool {
     Name = Scratch
     Pool Type = Backup
   }

   #
   # Restricted console used by tray-monitor to get the status of the dir
   Console {
     Name = bacula-mon
     Password = "gJ3UQ7D0pRRYjRv2FVzPmT0WJvCfnniwZ"
     CommandACL = status, .status
   }
   ```

3. **Configurar el Cliente**:

   Edita el archivo `/etc/bacula/bacula-fd.conf` en el cliente:

   ```bash
   sudo nano /etc/bacula/bacula-fd.conf
   ```

   **`bacula-fd.conf`**:

   ```conf
   #
   # Default Bacula File Daemon Configuration file
   #
   #  For Bacula release 7.0.x (04 February 2014) -- debian
   #
   # There is not much to change here except perhaps the
   # File daemon Name to
   # match the Director's Name resource.  However, you may
   # also want to check the
   # File daemon port, address, and Director's passwords.
   #
   # The messages resource is highly recommended
   # as it allows the File daemon
   # to send errors to the Director.
   #
   # For the Director, the only required password is to
   # connect to the File daemon.
   # For the Storage daemon, the only required password is
   # to connect to the File daemon.

   FileDaemon {                          # this is me
     Name = bac

ula-cliente-fd
     FDport = 9102                # where we listen for the director
     WorkingDirectory = /var/lib/bacula
     Pid Directory = /var/run/bacula
     Maximum Concurrent Jobs = 20
     FDAddress = 192.168.0.11
   }

   #
   # List Directors who are permitted to contact this File daemon
   #
   Director {
     Name = bacula-servidor-dir
     Password = "somepassword"          # Director's password
   }

   # Send all messages except skipped files back to Director
   Messages {
     Name = Standard
     director = bacula-servidor-dir@192.168.0.10 = all, !skipped, !restored
   }
   ```

### Cambios Realizados

1. **Dirección del Storage Daemon (`SDAddress`)**:
   - Cambié `SDAddress` a `192.168.0.10` para que el Storage Daemon escuche en la dirección correcta.

2. **Configuración del Director Permitido**:
   - La sección `Director` ya estaba configurada correctamente, solo aseguré que los nombres y las contraseñas sean consistentes.

3. **Directores Permitidos para Monitoreo**:
   - Aseguré que el director para monitoreo esté configurado correctamente.

4. **Configuración de Dispositivos y Autochanger**:
   - Actualicé las rutas de los dispositivos de archivo para que apunten a los directorios adecuados en `/mnt/backups` (asegúrate de crear estos directorios o ajustarlos según tu entorno).

5. **Mensajes**:
   - Configuré la sección de mensajes para enviar todos los mensajes al director en `192.168.0.10`.

6. **Clientes y Passwords**:
   - Configuré el cliente `bacula-cliente-fd` con la dirección IP `192.168.0.11` y la contraseña adecuada.

### Reiniciar Servicios

Después de realizar estos cambios, reinicia los servicios de Bacula en ambas instancias:

En el servidor:
```bash
sudo systemctl restart bacula-director
sudo systemctl restart bacula-sd
```

En el cliente:
```bash
sudo systemctl restart bacula-fd
```

### Configuración del Cifrado

1. **Generar Claves de Cifrado**:

   En el servidor, genera una clave GPG:

   ```bash
   gpg --gen-key
   ```

   Exporta la clave pública:

   ```bash
   gpg --export --armor "ID" > /etc/bacula/bacula_gpg.pub
   ```

2. **Cifrar Datos Críticos**:

   Edita el archivo `/etc/bacula/bacula-dir.conf` para incluir la configuración del cifrado:

   ```conf
   FileSet {
     Name = "CriticalData"
     Include {
       Options {
         signature = MD5
         compression = GZIP
         encryption = GPG
         GPGKey = /etc/bacula/bacula_gpg.pub
       }
       File = /home/username/critical_data
     }
   }
   ```

### Configuración de Cron para Limpieza Automática

1. **Script de Limpieza**:

   **limpieza_copias.sh:**

   ```bash
   #!/bin/bash
   find /mnt/backups -type f -mtime +30 -exec rm {} \;
   ```

   Guarda el script en `/usr/local/bin` y hazlo ejecutable:

   ```bash
   sudo mv limpieza_copias.sh /usr/local/bin/
   sudo chmod +x /usr/local/bin/limpieza_copias.sh
   ```

2. **Añadir Entrada en Cron**:

   Edita el crontab del usuario root:

   ```bash
   sudo crontab -e
   ```

   Añade la siguiente línea para ejecutar el script de limpieza cada domingo a las 1:00 AM:

   ```bash
   0 1 * * 0 /usr/local/bin/limpieza_copias.sh
   ```

### Sincronización con Ubicación Secundaria

1. **Configurar `rsync`**:

   **sync_remoto.sh:**

   ```bash
   #!/bin/bash
   rsync -avz /mnt/backups/ username@remote_server:/path/to/remote/backups/
   ```

   Guarda el script en `/usr/local/bin` y hazlo ejecutable:

   ```bash
   sudo mv sync_remoto.sh /usr/local/bin/
   sudo chmod +x /usr/local/bin/sync_remoto.sh
   ```

2. **Añadir Entrada en Cron**:

   Edita el crontab del usuario root:

   ```bash
   sudo crontab -e
   ```

   Añade la siguiente línea para ejecutar el script de sincronización cada domingo a las 3:00 AM:

   ```bash
   0 3 * * 0 /usr/local/bin/sync_remoto.sh
   ```

## Conclusión

Hemos configurado un sistema de copias de seguridad automático utilizando Bacula para las instancias en el cloud, cumpliendo con todos los requisitos especificados. Implementamos copias completas semanales y diferenciales diarias, almacenamiento cifrado para datos críticos, y sincronización con una ubicación secundaria. Esta configuración asegura que los datos estén protegidos y sean recuperables en caso de pérdida.